<?php

/**
 * Class Boxalino_Intelligence_Block_Result
 */
class Boxalino_Intelligence_Block_Result extends Mage_CatalogSearch_Block_Result{

    /**
     * @var bool
     */
    protected $fallback = false;

    /**
     * @var null
     */
    protected $subPhrases = null;

    /**
     * @var array
     */
    protected $queries = array();

    /**
     *
     */
    public function _construct(){
        
        $bxHelperData = Mage::helper('intelligence');
        if($bxHelperData->isSearchEnabled() && $this->hasSubPhrases()){
            $this->queries = $bxHelperData->getAdapter()->getSubPhrasesQueries();

            if(count($this->queries) < 2){
                $url = Mage::getUrl();
                $replace = '?q=' . $this->queries[0];
                $url = substr_replace ($url, $replace, strpos($url, '?'));
                Mage::app()->getFrontController()->getResponse()->setRedirect($url);
            }
        }
        parent::_construct(); // TODO: Change the autogenerated stub
    }

    /**
     * @param $index
     * @return string
     */
    public function getSearchQueryLink($index){

        return $this->_storeManager->getStore()->getBaseUrl() . "catalogsearch/result/?q=" . $this->queries[$index];
    }

    /**
     * @return int|null
     */
    public function hasSubPhrases(){

        if($this->fallback){
            return 0;
        }

        try{
            $bxHelperData = Mage::helper('intelligence');
            if($bxHelperData->isSearchEnabled()){
                if($this->subPhrases == null){
                    $this->subPhrases = $bxHelperData->getAdapter()->areThereSubPhrases();
                }
                return $this->subPhrases;
            }
        }catch(\Exception $e){
            $this->fallback = true;
        }
        return 0;
    }

    /**
     * @param string $template
     * @return $this|Mage_Core_Block_Template
     */
    public function setTemplate($template){

        $this->_template = 'boxalino/catalogsearch/result.phtml';
        return $this;
    }

    /**
     * @return mixed
     */
    public function getResultCount(){

        if (!$this->getData('result_count')) {
            $size = Mage::helper('intelligence')->getAdapter()->getTotalHitCount();
            $this->_getQuery()->setNumResults($size);
            $this->setResultCount($size);
        }
        return $this->getData('result_count');
    }

    /**
     * @return int
     */
    public function getSubPhrasesResultCount() {

        return sizeof($this->queries);
    }

    /**
     * @param $index
     * @return string
     */
    public function getSubPhrasesResultText($index){

        return __("Search result for: '%1'", $this->queries[$index] );
    }
}